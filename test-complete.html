<!DOCTYPE html>
<html>
  <head>
    <title>Test Complete Flow</title>
  </head>
  <body>
    <h1>Test Complete Frontend Flow</h1>
    <p>Data In√≠cio: <input type="date" id="dateStart" /></p>
    <p>Data Fim: <input type="date" id="dateEnd" /></p>
    <button onclick="setTodayInputs()">Hoje</button>
    <button onclick="testComplete()">Test Complete Flow</button>
    <div id="output"></div>

    <script>
      let BUCKET_URL =
        'https://bucket-tgferr-monitor.br-se1.magaluobjects.com/bucket-tgferr-monitor/';

      async function loadConfig() {
        try {
          const res = await fetch('./config.json');
          if (!res.ok) return;
          const cfg = await res.json();
          if (cfg.BUCKET_URL) {
            BUCKET_URL = cfg.BUCKET_URL;
            console.log('Config carregada:', BUCKET_URL);
          }
        } catch (e) {
          console.log('Erro ao carregar config:', e);
        }
      }

      function convertToDDMMYYYY(isoDate) {
        const [year, month, day] = isoDate.split('-');
        return `${day}-${month}-${year}`;
      }

      function setTodayInputs() {
        const TZ_OFFSET_MINUTES = -180;
        const now = new Date();
        now.setMinutes(now.getMinutes() + TZ_OFFSET_MINUTES);

        const pad = (n) => n.toString().padStart(2, '0');
        const iso = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(
          now.getDate()
        )}`;

        console.log('üîç DEBUG setTodayInputs:', {
          originalNow: new Date().toISOString(),
          TZ_OFFSET_MINUTES,
          adjustedNow: now.toISOString(),
          iso,
        });

        document.getElementById('dateStart').value = iso;
        document.getElementById('dateEnd').value = iso;
      }

      async function fetchHoursForDate(isoDate) {
        const date = convertToDDMMYYYY(isoDate);
        const base = BUCKET_URL.replace(/\/+$/, '');
        const url = `${base}/hours_${date}.json`;

        console.log('üîç DEBUG fetchHoursForDate:', {
          isoDate,
          date,
          BUCKET_URL,
          base,
          url,
        });

        try {
          console.log(`Tentando carregar horas: ${url}`);
          const res = await fetch(url);
          if (res.ok) {
            const json = await res.json();
            console.log('Sucesso! Dados:', json);
            return json;
          } else {
            console.log(`Erro ${res.status}: ${url}`);
            return null;
          }
        } catch (e) {
          console.log(`Erro de fetch: ${e.message}`);
          return null;
        }
      }

      async function testComplete() {
        await loadConfig();
        setTodayInputs();

        const start = document.getElementById('dateStart').value;
        const result = await fetchHoursForDate(start);

        const output = document.getElementById('output');
        output.innerHTML = `
                <h3>Test Complete Flow Results:</h3>
                <p><strong>Start Date:</strong> ${start}</p>
                <p><strong>Hours Data Found:</strong> ${
                  result ? 'YES' : 'NO'
                }</p>
                <p><strong>Data:</strong> <pre>${
                  result ? JSON.stringify(result, null, 2) : 'N/A'
                }</pre></p>
            `;
      }

      // Initialize
      loadConfig();
      setTodayInputs();
    </script>
  </body>
</html>
