<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Relat칩rios Roblox</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        color: #fff;
        font-weight: 600;
      }
      .badge.offline {
        background: #9e9e9e;
      }
      .badge.online {
        background: #4caf50;
      }
      .badge.ingame {
        background: #2196f3;
      }
      .badge.instudio {
        background: #ff9800;
      }
      .badge.invisible {
        background: #607d8b;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      th {
        background: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <h1>游늵 Relat칩rios de Jogadores Roblox</h1>

    <label>Data In칤cio: <input type="date" id="dateStart" /></label>
    <label>Data Fim: <input type="date" id="dateEnd" /></label>
    <label
      >Jogador:
      <select id="playerFilter">
        <option value="">(todos)</option>
      </select></label
    >
    <button onclick="loadReport()">Carregar</button>

    <div id="reportArea"></div>
    <canvas id="chart" height="100"></canvas>

    <script>
      let BUCKET_URL =
        "https://bucket-tgferr-monitor.br-se1.magaluobjects.com/";

      // Tenta carregar docs/config.json para sobrepor BUCKET_URL em desenvolvimento
      let playersMap = new Map();

      async function loadConfig() {
        try {
          const res = await fetch("./config.json");
          if (!res.ok) return;
          const cfg = await res.json();
          if (cfg.BUCKET_URL) {
            BUCKET_URL = cfg.BUCKET_URL;
            console.log("Config carregada:", BUCKET_URL);
          }
        } catch (e) {
          // silencioso - fallback mant칠m o BUCKET_URL embutido
        }
      }

      // Tenta carregar players.json local para mapear IDs -> nomes
      async function loadPlayers() {
        try {
          const res = await fetch("./players.json");
          if (!res.ok) return;
          const list = await res.json();
          for (const p of list) playersMap.set(String(p.id), p);
          console.log("Players carregados localmente", playersMap.size);
          // preencher select de filtro
          const sel = document.getElementById("playerFilter");
          for (const p of list) {
            const opt = document.createElement("option");
            opt.value = String(p.id);
            opt.textContent = `${p.displayName || p.name} (${p.id})`;
            sel.appendChild(opt);
          }
        } catch (e) {
          // silencioso
        }
      }

      // Tenta carregar um objeto JSON a partir de m칰ltiplos prefixes (prioriza reports/hours)
      async function fetchHoursForDate(date) {
        const base = BUCKET_URL.replace(/\/+$/, "");
        const candidates = [];
        // Se o base j치 termina com /reports, evite duplicar
        if (base.endsWith("/reports")) {
          candidates.push(`${base}/hours/${date}.json`);
          candidates.push(`${base}/${date}.json`);
          // tamb칠m tente sem o "/reports" (caso o bucket URL j치 aponte para a pasta)
          candidates.push(
            `${base.replace(/\/reports$/, "")}/hours/${date}.json`
          );
          candidates.push(`${base.replace(/\/reports$/, "")}/${date}.json`);
        } else {
          // base sem /reports
          candidates.push(`${base}/hours/${date}.json`);
          candidates.push(`${base}/${date}.json`);
          candidates.push(`${base}/reports/hours/${date}.json`);
          candidates.push(`${base}/reports/${date}.json`);
        }
        for (const url of candidates) {
          try {
            console.log(`Tentando carregar horas: ${url}`);
            const res = await fetch(url);
            if (res.ok) {
              const json = await res.json();
              // Validar estrutura esperada de relat칩rio de horas
              if (
                (json && typeof json === "object" && json.minutesByUser) ||
                (json && typeof json === "object" && json.hoursByUser)
              ) {
                console.log(`Horas: arquivo v치lido encontrado em ${url}`);
                return json;
              } else {
                console.log(
                  `Arquivo encontrado mas n칚o 칠 relat칩rio de horas (ignorando): ${url}`
                );
              }
            } else {
              console.log(`N칚o encontrado (status ${res.status}): ${url}`);
            }
          } catch (e) {
            console.log(`Erro ao fetch ${url}:`, e && e.message);
            // continua para o pr칩ximo
          }
        }
        return null;
      }

      // Carrega relat칩rio para um dia ou intervalo e aplica filtro de jogador
      async function loadReport() {
        const start = document.getElementById("dateStart").value;
        const end = document.getElementById("dateEnd").value;
        if (!start || !end) return alert("Escolha data in칤cio e fim!");
        const startDate = new Date(start);
        const endDate = new Date(end);
        if (startDate > endDate)
          return alert("Data in칤cio deve ser <= data fim");

        // filtro por jogador (opcional)
        const playerFilter = document.getElementById("playerFilter").value;

        // Para simplicidade mostramos apenas o primeiro dia selecionado na tabela
        const date = start; // manter compatibilidade com o formato YYYY-MM-DD
        const url = `${BUCKET_URL}/${date}.json`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("Relat칩rio n칚o encontrado");
          const data = await res.json();

          const hours = await fetchHoursForDate(date);

          // aplicar filtro por jogador (se houver)
          if (playerFilter) {
            data.userPresences = data.userPresences.filter(
              (p) => String(p.userId) === String(playerFilter)
            );
          }

          renderReport(data, hours);
        } catch (e) {
          alert("Erro: " + e.message);
        }
      }

      // Carrega config e players ao iniciar (n칚o bloqueante)
      loadConfig();
      loadPlayers();

      let chartInstance = null;

      function renderReport(data, hoursData) {
        const div = document.getElementById("reportArea");
        div.innerHTML = "";

        if (
          !Array.isArray(data.userPresences) ||
          data.userPresences.length === 0
        ) {
          div.innerHTML = "<p>Nenhum dado dispon칤vel para esta data.</p>";
          return;
        }

        let html =
          "<table><tr><th>Usu치rio</th><th>Presen칞a</th><th>칔ltima Localiza칞칚o</th><th>Horas hoje</th></tr>";

        for (const info of data.userPresences) {
          // Mapear presence types: 0=Offline,1=Online,2=InGame,3=InStudio,4=Invisible
          const presenceMap = {
            0: { text: "Offline", cls: "offline" },
            1: { text: "Online", cls: "online" },
            2: { text: "InGame", cls: "ingame" },
            3: { text: "InStudio", cls: "instudio" },
            4: { text: "Invisible", cls: "invisible" },
          };
          const p = presenceMap[info.userPresenceType] || {
            text: "Desconhecido",
            cls: "",
          };
          const presenceText = `<span class="badge ${p.cls}">${p.text}</span>`;

          const user = playersMap.get(String(info.userId));
          const title = user
            ? `${user.displayName} (${user.name})`
            : info.userId;

          const hoursText =
            hoursData &&
            hoursData.hoursByUser &&
            hoursData.hoursByUser[String(info.userId)]
              ? hoursData.hoursByUser[String(info.userId)] + " h"
              : "-";

          html += `<tr>
      <td>${title}<div style="font-size:0.9em;color:#666;">ID: ${
            info.userId
          }</div></td>
      <td>${presenceText}</td>
      <td>${info.lastLocation || "-"}</td>
      <td style="text-align:center">${hoursText}</td>
    </tr>`;
        }

        html += "</table>";
        div.innerHTML = html;

        // Gr치fico: mostrar todos os status (0..4) e cont치-los
        const statusCounts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, unknown: 0 };
        for (const p of data.userPresences) {
          const k = String(p.userPresenceType);
          if (k in statusCounts) statusCounts[k]++;
          else statusCounts.unknown++;
        }

        const labels = [
          "Offline",
          "Online",
          "InGame",
          "InStudio",
          "Invisible",
          "Desconhecido",
        ];
        const dataset = [
          statusCounts[0],
          statusCounts[1],
          statusCounts[2],
          statusCounts[3],
          statusCounts[4],
          statusCounts.unknown,
        ];

        const ctx = document.getElementById("chart");
        // Destr칩i instancia anterior do Chart.js para evitar erro "Canvas is already in use"
        if (chartInstance) {
          try {
            chartInstance.destroy();
          } catch (e) {
            /* ignore */
          }
          chartInstance = null;
        }

        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "N칰mero de jogadores",
                data: dataset,
                backgroundColor: [
                  "#f44336",
                  "#4caf50",
                  "#2196f3",
                  "#ff9800",
                  "#607d8b",
                  "#9e9e9e",
                ],
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true, precision: 0 },
            },
          },
        });
      }

      // Ao carregar a p치gina, preencher as datas (hoje) e players
      function setTodayInputs() {
        const today = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const iso = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(
          today.getDate()
        )}`;
        document.getElementById("dateStart").value = iso;
        document.getElementById("dateEnd").value = iso;
      }

      // inicializar
      setTodayInputs();
      loadPlayers();
    </script>
  </body>
</html>
