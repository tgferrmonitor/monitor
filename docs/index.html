<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Relat√≥rios Roblox</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="site-font">
      <div class="container">
        <div class="header">
          <h1>üìä Relat√≥rios de Jogadores Roblox</h1>
          <div class="muted">Visual moderno</div>
        </div>

        <div class="controls">
          <label>Data In√≠cio: <input type="date" id="dateStart" /></label>
          <label>Data Fim: <input type="date" id="dateEnd" /></label>
          <label
            >Jogador:
            <select id="playerFilter">
              <option value="">(todos)</option>
            </select></label
          >
          <label
            >Ordenar por:
            <select id="sortBy">
              <option value="presence">Presen√ßa</option>
              <option value="hours">Horas</option>
            </select></label
          >
          <label
            >Ordem:
            <select id="sortDir">
              <option value="desc">Desc</option>
              <option value="asc">Asc</option>
            </select></label
          >
          <div class="flex">
            <button class="btn" onclick="loadReport()">Carregar</button>
            <button class="btn secondary" onclick="setTodayInputs()">
              Hoje
            </button>
            <button class="btn secondary" onclick="exportCSV()">
              Export CSV
            </button>
            <button class="btn secondary" onclick="printReport()">
              Imprimir
            </button>
          </div>
        </div>

        <div id="reportArea" class="card"></div>

        <div class="chart-wrap">
          <div class="chart-card card">
            <canvas id="chart" height="140"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      let BUCKET_URL =
        'https://bucket-tgferr-monitor.br-se1.magaluobjects.com/bucket-tgferr-monitor/';

      // Tenta carregar docs/config.json para sobrepor BUCKET_URL em desenvolvimento
      let playersMap = new Map();

      function convertToDDMMYYYY(isoDate) {
        const [year, month, day] = isoDate.split('-');
        return `${day}-${month}-${year}`;
      }

      async function loadConfig() {
        try {
          const res = await fetch('./config.json');
          if (!res.ok) return;
          const cfg = await res.json();
          if (cfg.BUCKET_URL) {
            BUCKET_URL = cfg.BUCKET_URL;
            console.log('Config carregada:', BUCKET_URL);
          }
        } catch (e) {
          // silencioso - fallback mant√©m o BUCKET_URL embutido
        }
      }

      // Tenta carregar players.json local para mapear IDs -> nomes
      async function loadPlayers() {
        try {
          const res = await fetch('./players.json');
          if (!res.ok) return;
          const list = await res.json();
          for (const p of list) playersMap.set(String(p.id), p);
          console.log('Players carregados localmente', playersMap.size);
          // preencher select de filtro
          const sel = document.getElementById('playerFilter');
          for (const p of list) {
            const opt = document.createElement('option');
            opt.value = String(p.id);
            opt.textContent = `${p.displayName || p.name} (${p.id})`;
            sel.appendChild(opt);
          }
        } catch (e) {
          // silencioso
        }
      }

      async function fetchHoursForDate(isoDate) {
        const date = convertToDDMMYYYY(isoDate);
        const base = BUCKET_URL.replace(/\/+$/, '');
        const url = `${base}/hours_${date}.json`;

        try {
          console.log(`Tentando carregar horas: ${url}`);
          const res = await fetch(url);
          if (res.ok) {
            const json = await res.json();
            if (
              (json && typeof json === 'object' && json.minutesByUser) ||
              (json && typeof json === 'object' && json.hoursByUser)
            ) {
              console.log(`Horas: arquivo v√°lido encontrado em ${url}`);
              return json;
            } else {
              console.log(
                `Arquivo encontrado mas n√£o √© relat√≥rio de horas (ignorando): ${url}`
              );
            }
          } else {
            console.log(`N√£o encontrado (status ${res.status}): ${url}`);
          }
        } catch (e) {
          console.log(`Erro ao fetch ${url}:`, e && e.message);
        }
        return null;
      }

      // Agrega horas ao longo do intervalo selecionado
      async function aggregateHoursForRange(start, end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        const minutesByUser = {};

        for (
          let d = new Date(startDate);
          d <= endDate;
          d.setDate(d.getDate() + 1)
        ) {
          const pad = (n) => n.toString().padStart(2, '0');
          const key = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
            d.getDate()
          )}`;
          try {
            const hours = await fetchHoursForDate(key);
            if (hours && hours.minutesByUser) {
              for (const [uid, mins] of Object.entries(hours.minutesByUser)) {
                minutesByUser[uid] = (minutesByUser[uid] || 0) + mins;
              }
            }
          } catch (e) {
            // continua
          }
        }

        // montar objeto conveni√™ncia hoursByUser
        const hoursByUser = {};
        for (const [uid, mins] of Object.entries(minutesByUser)) {
          hoursByUser[uid] = Math.round((mins / 60) * 100) / 100;
        }

        return { minutesByUser, hoursByUser };
      }

      // Carrega relat√≥rio para um dia (exibe presen√ßas do primeiro dia) e agrega horas no intervalo
      async function loadReport() {
        const start = document.getElementById('dateStart').value;
        const end = document.getElementById('dateEnd').value;
        if (!start || !end) return alert('Escolha data in√≠cio e fim!');
        const startDate = new Date(start);
        const endDate = new Date(end);
        if (startDate > endDate)
          return alert('Data in√≠cio deve ser <= data fim');

        // filtro por jogador (opcional)
        const playerFilter = document.getElementById('playerFilter').value;

        // Mostrar presen√ßas do dia inicial (mantendo compatibilidade)
        const date = convertToDDMMYYYY(start);
        const url = `${BUCKET_URL.replace(/\/+$/, '')}/results_${date}.json`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('Relat√≥rio n√£o encontrado');
          const data = await res.json();

          const aggregatedHours = await aggregateHoursForRange(start, end);

          // aplicar filtro por jogador (se houver)
          if (playerFilter) {
            data.userPresences = data.userPresences.filter(
              (p) => String(p.userId) === String(playerFilter)
            );
          }

          renderReport(data, aggregatedHours);
        } catch (e) {
          alert('Erro: ' + e.message);
        }
      }

      // Carrega config e players ao iniciar (n√£o bloqueante)
      loadConfig();
      loadPlayers();

      let chartInstance = null;

      function renderReport(data, hoursData) {
        const div = document.getElementById('reportArea');
        div.innerHTML = '';

        if (
          !Array.isArray(data.userPresences) ||
          data.userPresences.length === 0
        ) {
          div.innerHTML = '<p>Nenhum dado dispon√≠vel para esta data.</p>';
          return;
        }

        // ordenar e paginar
        const sortBy = document.getElementById('sortBy')
          ? document.getElementById('sortBy').value
          : 'presence';
        const sortDir = document.getElementById('sortDir')
          ? document.getElementById('sortDir').value
          : 'desc';

        // criar c√≥pia para ordena√ß√£o
        let presList = Array.from(data.userPresences || []);

        // auxiliar: obter horas do aggregated hoursData
        const getHours = (uid) =>
          (hoursData && hoursData.hoursByUser && hoursData.hoursByUser[uid]) ||
          0;

        presList.sort((a, b) => {
          if (sortBy === 'hours') {
            return (
              (getHours(b.userId) - getHours(a.userId)) *
              (sortDir === 'asc' ? -1 : 1)
            );
          }
          // ordenar por presence type
          return (
            (b.userPresenceType - a.userPresenceType) *
            (sortDir === 'asc' ? -1 : 1)
          );
        });

        // pagina√ß√£o simples
        const pageSize = 10;
        const page = 1; // futuro: adicionar controle

        const startIndex = (page - 1) * pageSize;
        const pageSlice = presList.slice(startIndex, startIndex + pageSize);

        let html =
          '<table><tr><th>Usu√°rio</th><th>Presen√ßa</th><th>√öltima Localiza√ß√£o</th><th>Horas hoje</th></tr>';

        for (const info of pageSlice) {
          // Mapear presence types: 0=Offline,1=Online,2=InGame,3=InStudio,4=Invisible
          const presenceMap = {
            0: { text: 'Offline', cls: 'offline' },
            1: { text: 'Online', cls: 'online' },
            2: { text: 'InGame', cls: 'ingame' },
            3: { text: 'InStudio', cls: 'instudio' },
            4: { text: 'Invisible', cls: 'invisible' },
          };
          const p = presenceMap[info.userPresenceType] || {
            text: 'Desconhecido',
            cls: '',
          };
          const presenceText = `<span class="badge ${p.cls}">${p.text}</span>`;

          const user = playersMap.get(String(info.userId));
          const title = user
            ? `${user.displayName} (${user.name})`
            : info.userId;

          const hoursText =
            hoursData &&
            hoursData.hoursByUser &&
            hoursData.hoursByUser[String(info.userId)]
              ? hoursData.hoursByUser[String(info.userId)] + ' h'
              : '-';

          html += `<tr>
      <td>${title}<div style="font-size:0.9em;color:#666;">ID: ${
            info.userId
          }</div></td>
      <td>${presenceText}</td>
      <td>${info.lastLocation || '-'}</td>
      <td style="text-align:center">${hoursText}</td>
    </tr>`;
        }

        html += '</table>';
        div.innerHTML = html;

        // adicionar pagina√ß√£o / info
        const pg = document.createElement('div');
        pg.className = 'muted';
        pg.textContent = `Mostrando ${startIndex + 1} - ${
          startIndex + pageSlice.length
        } de ${presList.length}`;
        div.appendChild(pg);

        // Gr√°fico: mostrar todos os status (0..4) e cont√°-los
        const statusCounts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, unknown: 0 };
        for (const p of data.userPresences) {
          const k = String(p.userPresenceType);
          if (k in statusCounts) statusCounts[k]++;
          else statusCounts.unknown++;
        }

        const labels = [
          'Offline',
          'Online',
          'InGame',
          'InStudio',
          'Invisible',
          'Desconhecido',
        ];
        const dataset = [
          statusCounts[0],
          statusCounts[1],
          statusCounts[2],
          statusCounts[3],
          statusCounts[4],
          statusCounts.unknown,
        ];

        const ctx = document.getElementById('chart');
        // Destr√≥i instancia anterior do Chart.js para evitar erro "Canvas is already in use"
        if (chartInstance) {
          try {
            chartInstance.destroy();
          } catch (e) {
            /* ignore */
          }
          chartInstance = null;
        }

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'N√∫mero de jogadores',
                data: dataset,
                backgroundColor: [
                  '#f44336',
                  '#4caf50',
                  '#2196f3',
                  '#ff9800',
                  '#607d8b',
                  '#9e9e9e',
                ],
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true, precision: 0 },
            },
          },
        });
      }

      // Ao carregar a p√°gina, preencher as datas (hoje) e players
      function setTodayInputs() {
        // Usar o mesmo timezone offset que o backend (-180 minutos = GMT-3)
        const TZ_OFFSET_MINUTES = -180;
        const now = new Date();
        now.setMinutes(now.getMinutes() + TZ_OFFSET_MINUTES);

        const pad = (n) => n.toString().padStart(2, '0');
        const iso = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(
          now.getDate()
        )}`;
        document.getElementById('dateStart').value = iso;
        document.getElementById('dateEnd').value = iso;
      }

      // Export CSV da tabela atual
      function exportCSV() {
        const table = document.querySelector('#reportArea table');
        if (!table) return alert('Nada para exportar');
        const rows = [];
        for (const tr of table.querySelectorAll('tr')) {
          const cols = Array.from(tr.querySelectorAll('th,td')).map((n) =>
            n.textContent.trim()
          );
          rows.push(cols.join(','));
        }
        const csv = rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report-${
          document.getElementById('dateStart').value || 'report'
        }.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function printReport() {
        window.print();
      }

      // inicializar
      setTodayInputs();
      loadPlayers();
    </script>
  </body>
</html>
